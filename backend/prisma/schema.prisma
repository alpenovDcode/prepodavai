// Prisma Schema для PrepodavAI
// Миграция с Chatium Heap на PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователи приложения
model AppUser {
  id                    String    @id @default(uuid())
  userHash              String?   @unique
  source                String?   // 'web' | 'telegram'
  telegramId            String?   @unique
  chatId                String?   // ID чата в Telegram
  username              String?
  apiKey                String?   @unique
  firstName             String?
  lastName              String?
  phone                 String?
  phoneVerified         Boolean   @default(false)
  lastAccessAt          DateTime?
  lastTelegramAppAccess DateTime?
  passwordHash          String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Связи
  subscription          UserSubscription?
  generations           UserGeneration[]
  creditTransactions    CreditTransaction[]
  systemLogs            SystemLog[]

  @@index([telegramId])
  @@index([userHash])
  @@index([apiKey])
  @@map("app_users")
}

// Тарифные планы
model SubscriptionPlan {
  id                  String   @id @default(uuid())
  planKey             String   @unique // 'starter', 'pro', 'business'
  planName            String
  monthlyCredits      Int
  price               Decimal  @db.Decimal(10, 2)
  currency            String   @default("RUB")
  allowOverage        Boolean  @default(false)
  overageCostPerCredit Decimal? @db.Decimal(10, 2)
  features            String[] // Array of features
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Связи
  subscriptions       UserSubscription[]

  @@map("subscription_plans")
}

// Подписки пользователей
model UserSubscription {
  id                String   @id @default(uuid())
  userId            String   @unique
  planId            String
  status            String   // 'active', 'inactive', 'expired'
  creditsBalance    Int      @default(0)
  extraCredits      Int      @default(0)
  creditsUsed       Int      @default(0)
  overageCreditsUsed Int     @default(0)
  startDate         DateTime
  endDate           DateTime
  autoRenew         Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Связи
  user              AppUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan @relation(fields: [planId], references: [id])
  transactions      CreditTransaction[]

  @@map("user_subscriptions")
}

// Стоимость операций
model CreditCost {
  id            String   @id @default(uuid())
  operationType String   @unique
  operationName String
  creditCost    Int
  description   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("credit_costs")
}

// Транзакции кредитов
model CreditTransaction {
  id                String   @id @default(uuid())
  userId            String
  subscriptionId    String
  type              String   // 'debit', 'credit', 'grant', 'refund', 'monthly_reset'
  amount            Int
  balanceBefore     Int
  balanceAfter      Int
  operationType     String?  // Тип операции генерации
  generationRequestId String?
  description       String?
  metadata          Json?    // Дополнительные данные
  createdAt         DateTime @default(now())

  // Связи
  user              AppUser  @relation(fields: [userId], references: [id])
  subscription      UserSubscription @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@index([generationRequestId])
  @@map("credit_transactions")
}

// Запросы генерации (старая таблица для совместимости)
model GenerationRequest {
  id        String   @id @default(uuid())
  userId    String
  type      String   // Тип генерации
  params    Json?    // Параметры запроса
  status    String   // 'pending', 'completed', 'failed'
  result    Json?    // Результат генерации
  error     String?
  model     String?
  metadata  Json?    // Дополнительные данные (например, replicatePredictionId)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  userGeneration UserGeneration?

  @@index([userId])
  @@index([status])
  @@map("generation_requests")
}

// Генерации пользователей (новая таблица с детальными данными)
model UserGeneration {
  id                  String   @id @default(uuid())
  userId              String
  generationType      String   // Тип генерации
  status              String   // 'pending', 'completed', 'failed'
  inputParams         Json?    // Параметры запроса
  outputData          Json?    // Полный результат генерации
  errorMessage        String?
  model               String?
  generationRequestId String   @unique
  sentToTelegram      Boolean  @default(false)
  telegramSentAt      DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Связи
  user                AppUser  @relation(fields: [userId], references: [id])
  generationRequest   GenerationRequest @relation(fields: [generationRequestId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([generationType])
  @@index([generationRequestId])
  @@map("user_generations")
}

// Системные логи
model SystemLog {
  id                String   @id @default(uuid())
  level             String   // 'info', 'warn', 'error'
  category          String   // 'telegram_send', 'generation', 'user_auth', 'webhook'
  message           String
  data              Json?
  userId            String?
  generationRequestId String?
  timestamp         DateTime @default(now())

  // Связи
  user              AppUser? @relation(fields: [userId], references: [id])

  @@index([level])
  @@index([category])
  @@index([userId])
  @@index([timestamp])
  @@map("system_logs")
}

// Планы уроков (дополнительная таблица)
model LessonPlan {
  id          String   @id @default(uuid())
  userId      String
  subject     String
  topic       String
  level       String
  content     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("lesson_plans")
}

// Материалы (дополнительная таблица)
model Material {
  id          String   @id @default(uuid())
  userId      String
  title       String
  type        String
  content     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("materials")
}

// Сообщения чата
model ChatMessage {
  id          String   @id @default(uuid())
  userId      String
  role        String   // 'user', 'assistant'
  content     String
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("chat_messages")
}

// Коды верификации
model VerificationCode {
  id          String   @id @default(uuid())
  userId      String?
  phone       String
  code        String
  type        String   // 'sms', 'email'
  verified    Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([phone])
  @@index([code])
  @@map("verification_codes")
}
