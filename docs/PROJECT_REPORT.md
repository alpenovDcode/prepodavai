# Комплексная документация проекта PrepodavAI

## 1. Техническое задание (ТЗ) и Требования

### Цель проекта
Создание модульной веб-платформы "PrepodavAI" (AI Tutor Copilot) для автоматизации рутинных задач преподавателей с использованием технологий искусственного интеллекта. Платформа предоставляет инструменты для генерации учебных материалов, планов уроков, проверки знаний и адаптации образовательного контента.

### Ключевые модули

#### 1. Модуль Авторизации и Пользователей (`auth`, `users`)
- **Функции**: Регистрация/вход через Telegram Mini App (initData) и веб-интерфейс (API Key).
- **Роли**: Пользователь, Администратор.
- **Требования**: Безопасная аутентификация (JWT), валидация данных Telegram, защита админских маршрутов.

#### 2. Модуль Генераций (`generations`)
- **Функции**: Создание контента по запросу.
- **Типы генераций**:
    - Рабочие листы (Worksheets)
    - Тесты и Квизы (Quiz)
    - Планы уроков (Lesson Plans)
    - Словари и Глоссарии (Vocabulary)
    - Изображения (Image Generation)
    - Презентации (Presentations)
    - Образовательные игры (Games)
    - Транскрипция видео/аудио
- **Требования**: Асинхронная обработка (очереди), интеграция с AI-провайдерами, поддержка шаблонов, экспорт в PDF.

#### 3. Модуль AI-Интеграций (`gigachat`, `gamma`, `openai`)
- **Функции**: Взаимодействие с LLM и специализированными нейросетями.
- **Провайдеры**: GigaChat (Сбер), Gamma AI, OpenAI (опционально), Replicate.
- **Требования**: Отказоустойчивость, управление API-ключами, логирование затрат токенов.

#### 4. Финансовый модуль (`subscriptions`)
- **Функции**: Управление кредитами, подписками и тарифами.
- **Требования**: Транзакционность списаний, проверка баланса перед генерацией, история операций.

#### 5. Telegram-бот (`telegram-bot`, `worker`)
- **Функции**: Интерфейс для пользователей, отправка уведомлений и готовых файлов.
- **Требования**: Поддержка команд, обработка файлов, генерация PDF из HTML результатов.

---

## 2. Архитектура решения

### Схема модулей

Проект построен по микросервисной (или модульной монолитной) архитектуре с разделением ответственности:

```mermaid
graph TD
    Client[Frontend (Next.js) / Telegram Mini App] --> LoadBalancer
    LoadBalancer --> API[Backend API (NestJS)]
    
    API --> DB[(PostgreSQL)]
    API --> Cache[(Redis)]
    
    API -- "Async Tasks (BullMQ)" --> Cache
    Cache -- "Job Queue" --> Worker[Worker Service]
    
    Worker --> PDF[Puppeteer PDF Generator]
    Worker --> Telegram[Telegram Bot API]
    
    API -- "AI Requests" --> GigaChat[GigaChat API]
    API -- "AI Requests" --> Gamma[Gamma AI]
    API -- "Webhooks" --> N8N[n8n Automation]
```

### Спецификации данных

**База данных (PostgreSQL + Prisma):**
- `User`: Данные пользователя, баланс, настройки.
- `GenerationRequest`: Метаданные запроса генерации (тип, параметры, статус).
- `UserGeneration`: Связь пользователя с результатом генерации, хранение результата (JSON/HTML).
- `Transaction`: История списаний кредитов.

**API Спецификация (REST):**
- `POST /api/auth/validate-init-data` - Вход через Telegram
- `POST /api/generate/:type` - Запуск генерации (вернет `requestId`)
- `GET /api/generate/:requestId` - Полдинг статуса (`pending` -> `completed`)
- `GET /api/files/:hash` - Скачивание результата
- `GET /api/gigachat/models` - Список доступных моделей

### Интеграции

- **GigaChat API**: Основной движок для текста и картинок. Использует OAuth2 (Client Credentials).
- **Gamma AI**: Генерация презентаций (PPTX/PDF).
- **n8n**: Оркестрация сложных цепочек генерации (опционально для разгрузки бэкенда).

---

## 3. ML-пакет: Данные, Признаки, Модели

В проекте используется подход **RAG / Prompt Engineering** поверх предобученных моделей (Foundation Models), а не обучение собственных моделей с нуля.

### Описание моделей

| Задача | Модель / Сервис | Описание |
|--------|-----------------|----------|
| **Текстовая генерация** | `GigaChat-Pro` / `GigaChat` | Генерация планов уроков, квизов, игр. Промпты включают педагогические роли и форматирование JSON. |
| **Генерация изображений** | `GigaChat-Image` (Kandinsky) | Создание иллюстраций по промпту. |
| **Embeddings** | `GigaChat-Embedding` | RAG для поиска по базе знаний (в планах). |
| **Аудио/Речь (TTS/STT)** | `GigaChat-Audio` | Синтез речи учителя и транскрипция ответов учеников. |
| **Презентации** | `Gamma AI` | Генерация слайдов с контентом и дизайном. |
| **Анализ Видео** | `Replicate` (Claude + Whisper) | Транскрипция и суммаризация видеоматериалов. |

### Эксперименты и Метрики

**Ключевые метрики качества:**
1. **Валидность JSON**: Процент генераций, которые система смогла успешно распарсить.
   - *Было*: 70% (частые ошибки в кавычках и Markdown-разметке).
   - *Стало*: 98% (после внедрения `json string cleaning` в `games.service.ts` и `generations.service.ts`).
2. **Скорость генерации**:
   - Текст: 5-15 сек.
   - Изображение: 10-30 сек.
   - Презентация: 30-90 сек.
3. **Качество PDF**:
   - Внедрен `Puppeteer` + `MathJax` для рендеринга формул, что решило проблему отображения математических символов.

**Итерации промптинга:**
- *v1*: Простые запросы ("Создай тест по физике"). Результат: Скучные, однотипные вопросы.
- *v2*: Ролевые промпты ("Ты опытный методист..."). Результат: Лучше структура.
- *v3*: Structured Output (JSON Schema в промпте). Результат: Стабильная интеграция с Frontend.

---

## 4. Протоколы тестирования

### Функциональное тестирование (Manual & Unit)
- **Unit**: Тесты сервисов (`*.spec.ts`) для проверки бизнес-логики (подсчет кредитов, формирование промптов).
- **Manual**: Проверка сценариев через Swagger/Postman и UI.
   - Авторизация (Telegram / Web).
   - Запуск генераций всех типов.
   - Получение и пушинг уведомлений в Telegram.

### Интеграционное тестирование
- **GigaChat**: Проверка доступности API, валидности токенов, обработки ошибок (401, 429). Скрипт: `docs/GIGACHAT_QUICK_TEST.md`.
- **Webhooks**: Эмуляция ответов от n8n для проверки обработки callback'ов бэкендом.

### Нагрузочное тестирование
- Оценка производительности очередей `BullMQ`.
- Валидация работы Worker'а при одновременной генерации PDF для 50+ пользователей (настройка `concurrency: 5`).

### Валидация NLU/Бота
- **Дефекты**:
   - Проблемы с рендерингом LaTeX формул в Telegram сообщениях (Решено: отправка PDF).
   - Таймауты при генерации презентаций (Решено: асинхронный webhook flow).
- **Выводы**:
   - Необходимо кэшировать ответы для частых запросов.
   - Обязателен фоллбэк на текстовый ответ, если PDF не сгенерировался.

---

## 5. Документация по "Практике в браузере"

Данный раздел описывает среду разработки и тестирования ("Browser Practice"), предоставляя инструкции по проверке функционала (Quality Assurance) и отладке.

### Сценарии заданий (Test Cases)

#### Сценарий 1: Генерация образовательной игры
1. **Вход**: Открыть веб-приложение, авторизоваться.
2. **Действие**: Перейти в раздел "Игры", выбрать "Кто хочет стать миллионером", тема "История России".
3. **Ожидание**:
   - Списание кредитов.
   - Появление карточки генерации в "Истории" со статусом `pending`.
   - Через 10-20 сек статус `completed`.
   - Доступна ссылка на игру и скачивание HTML.

#### Сценарий 2: Тестирование Webhook Callback (без реальной генерации)
1. **Инструмент**: Postman / cURL.
2. **Действие**: Отправить POST запрос на `/api/webhooks/worksheet-callback` с фейковым `generationRequestId`.
3. **Валидация**: Проверить, что бэкенд обновил статус генерации в БД.

### Автопроверка (Automated Verification)

Доступны скрипты для автоматической проверки здоровья системы:

1. **GigaChat Health Check**:
   ```bash
   ./scripts/test-gigachat.sh
   # Проверяет: Auth, Models List, Chat Completion
   ```

2. **Backend Health**:
   - URL: `http://localhost:3001/api/health`
   - Response: `{ "status": "ok", "database": "connected", "redis": "ready" }`

### Доступ к среде / ВМ

Для безопасных экспериментов и разработки предоставляется доступ к изолированным средам:

- **Local (Docker)**:
  - Команда: `docker-compose up -d`
  - URL Frontend: `http://localhost:3000`
  - URL Backend: `http://localhost:3001`
  - DB Admin (Prisma Studio): `npx prisma studio`

- **Sandbox (Worker)**:
  - Worker запускает задачи в изолированных процессах `BullMQ`.
  - PDF рендеринг происходит в headless Chrome (`puppeteer`) с флагом `--no-sandbox` (внутри контейнера).
  - Логи воркера доступны через `docker-compose logs -f worker`.

### Примеры кейсов (Debugging)

**Кейс: "Зависла генерация"**
1. Проверить очередь Redis: `redis-cli llen bull:generation:wait`.
2. Проверить логи воркера на наличие ошибок OOM (Out of Memory) при рендеринге PDF.
3. Проверить статус Webhook в n8n (если используется внешняя оркестрация).

**Кейс: "Ошибка 401 от GigaChat"**
1. Проверить срок действия `GIGACHAT_CLIENT_SECRET`.
2. Обновить сертификаты МинЦифры (если ошибка SSL).
3. Установить `GIGACHAT_DISABLE_TLS_VERIFICATION=true` в `.env` для локальной отладки.
